# This workflows will upload a Python Package using Twine when a release is created
# For more information see: https://help.github.com/en/actions/language-and-framework-guides/using-python-with-github-actions#publishing-to-package-registries

name: Upload Python Package

on:
  release:
    types: [created]

jobs:
  deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install skbuild setuptools wheel twine
        
    - name: Install Native Code dependencies
      run: |
        sudo apt-get update -qq
        sudo apt install gcc g++
        sudo apt install openmpi-bin libopenmpi-dev
        sudo apt install libboost-all-dev libboost-mpi-dev libboost-mpi-python-dev
        sudo apt install libopenblas-dev liblapack-dev
        sudo apt install libgsl-dev
        sudo apt install python3 python-dev python3-pip
        sudo apt install python3-setuptools
        sudo pip3 install -r requirements.txt
        sudo apt-get install autoconf
        wget http://www.met.reading.ac.uk/clouds/adept/adept-2.0.5.tar.gz
        tar -xvf adept-2.0.5.tar.gz
        cd adept-2.0.5/
        ./configure && make -j2 && sudo make install
        cd include && ./create_adept_source_header
        sudo cp adept_source.h /usr/local/include/
        cd ../..

    - name: Build and publish
      env:
        TWINE_USERNAME: ${{ secrets.TEST_PYPI_USERNAME }}
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_PASSWORD }}
      run: |
        python3 setup.py bdist_wheel bdist_wheel -- -- -j2
        twine upload dist/*
